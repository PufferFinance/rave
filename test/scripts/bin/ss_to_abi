#!/bin/bash

# Conf -- set paths to secure signer #############################################
signer_root=$1
SECURE_SIGNER_PORT=9001
if [ "$signer_root" == "" ]; then
    echo "./ss_to_abi '/home/matthew/projects/secure-signer'"
    exit
fi

#############################################

# Constants used by the script.
ROOT_CA_MOD="9F3C647EB5773CBB512D2732C0D7415EBB55A0FA9EDE2E649199E6821DB910D53177370977466A6A5E4786CCD2DDEBD4149D6A2F6325529DD10CC98737B0779C1A07E29C47A1AE004948476C489F45A5A15D7AC8ECC6ACC645ADB43D87679DF59C093BC5A2E9696C5478541B979E754B573914BE55D32FF4C09DDF27219934CD990527B3F92ED78FBF29246ABECB71240EF39C2D7107B447545A7FFB10EB060A68A98580219E36910952683892D6A5E2A80803193E407531404E36B315623799AA825074409754A2DFE8F5AFD5FE631E1FC2AF3808906F28A790D9DD9FE060939B125790C5805D037DF56A99531B96DE69DE33ED226CC1207D1042B5C9AB7F404FC711C0FE4769FB9578B1DC0EC469EA1A25E0FF9914886EF2699B235BB4847DD6FF40B606E6170793C2FB98B314587F9CFD257362DFEAB10B3BD2D97673A1A4BD44C453AAF47FC1F2D3D0F384F74A06F89C089F0DA6CDB7FCEEE8C9821A8E54F25C0416D18C46839A5F8012FBDD3DC74D256279ADC2C0D55AFF6F0622425D1B"
ROOT_CA_EXP="010001"

# Key variables used by the script.
ss_out_path=$signer_root/ss_out
signer_path=$signer_root/target/x86_64-unknown-linux-musl/release/secure-signer
client_path=$signer_root/target/debug/client
enclave_path=$signer_root/Secure-Signer

# Get enclave hash values.
pushd ${enclave_path} > /dev/null
mrenclave=$(occlum print mrenclave) # hex
mrsigner=$(occlum print mrsigner)
popd > /dev/null

# Extract required fields from the keygen response.
keygen_response=$(cat $ss_out_path/keygen_response)
sig=$(echo $keygen_response | jq -r '.evidence.signed_report')
report=$(echo $keygen_response | jq -r '.evidence.raw_report')
certs=$(echo $keygen_response | jq -r '.evidence.signing_cert')

# Get the right cert from the certs list.
leaf_cert_pem=$(echo "$certs" | ./get_report_cert)

# Convert it to DER format and store as hex.
leaf_cert_hex=$(echo "$leaf_cert_pem" | ./pem_to_der | ./to_hex)

# Convert signature from b64 and store as hex.
sig_hex=$(echo "$sig" | base64 --decode | ./to_hex)

# Convert report JSON to hex format (don't add extra new line!)
report_hex=$(echo -n "$report" | ./to_hex)

# Extract fields from JSON report and store as ABI encoded hex.
report_calldata_hex=$(echo -n "$report" | ./report_to_calldata)

# Inputs should all be hex.
abi_out=$(
    ./fields_to_abi \
    "$report_calldata_hex" \
    "$sig_hex" \
    "$leaf_cert_hex" \
    "$ROOT_CA_MOD" \
    "$ROOT_CA_EXP" \
    "$mrenclave" \
    "$mrsigner"
)

echo -n $abi_out
